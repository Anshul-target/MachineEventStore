apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: machine-event-store-hpa

  labels:
    app: machine-event-store
spec:
  # Target deployment
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: machine-event-store

  # Min and max replicas
  minReplicas: 2
  maxReplicas: 10

  # Scaling behavior
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5 minutes before scaling down
      policies:
        - type: Percent
          value: 50              # Scale down max 50% of current pods
          periodSeconds: 60      # Per minute
        - type: Pods
          value: 2               # Or scale down max 2 pods
          periodSeconds: 60      # Per minute
      selectPolicy: Min        # Use minimum of the two policies

    scaleUp:
      stabilizationWindowSeconds: 0    # Scale up immediately
      policies:
        - type: Percent
          value: 100             # Double pods if needed
          periodSeconds: 15      # Every 15 seconds
        - type: Pods
          value: 4               # Or add max 4 pods
          periodSeconds: 15      # Every 15 seconds
      selectPolicy: Max        # Use maximum of the two policies

  # Metrics to scale on
  metrics:
    # CPU-based scaling
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70  # Scale when avg CPU > 70%

    # Memory-based scaling
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80  # Scale when avg memory > 80%

